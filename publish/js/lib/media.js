function validateMediaName(a){var b=/[<>\*\?:\^|"]/ig,c={};return a.match(b)?c={status:!1,message:"格式不正确"}:a.getRealLength()>50?c={status:!1,message:"长度不能超过50字节"}:c={status:!0,message:""},c}function validateImage(a){var b=/image*/i;return b.test(a)?!0:!1}function compressAndUpload(){var a=$("#mediaNav").attr("currentId")?$("#mediaNav").attr("currentId"):"",b="/uploadPPT";$("#compressAndUpload").fileupload({url:b,dataType:"json",singleFileUploads:!1,add:function(a,b){var c=$("#filelist"),d='<tr class="fade in"><td class="col-xs-10">',e="</td></tr>",f=!0;$.each(b.files,function(a,b){validateImage(b.type)||(f=!1),c.append(d+b.name+e)}),$("#compressCancelBtn").click(function(){location.reload()}),$("#compressModalClose").click(function(){location.reload()}),$("#compressNameDiv").css("display","block"),f?b.context=$("#compressUploadBtn").click(function(){var a=$("#compressName").val().trim();a===""?$("#compressNameAlert").css("display","block"):(b.compressname=a,b.submit(),$("#compressAndUpload").fileupload("disable"),$("#uploadInput").fileupload("disable"),$("#uploadFilesModal").modal("hide"))}):$("#compressTypeAlert").css("display","block")},done:function(b,c){c.result?c.result.status?$.ajax({type:"POST",url:"/compressPPT?path="+a+"&compressname="+c.compressname+"&tmpDir="+c.result.message,dataType:"JSON"}).done(function(a){console.log(a),a.status==="success"?alert("打包上传成功"):alert("打包上传失败"),location.reload()}):(alert(c.result.message),location.reload()):(alert("未知的错误"),location.reload())},progressall:function(a,b){var c=parseInt(b.loaded/b.total*100,10);$("#cprogress").show(),$("#cprogress .progress-bar").css("width",c+"%"),$("#cprogresspercent").html(c+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?undefined:"disabled")}function fileUpload(){var a=$("#mediaNav").attr("currentId")?$("#mediaNav").attr("currentId"):"",b="/upload/media?path="+a;$("#uploadInput").fileupload({url:b,dataType:"json",add:function(a,b){$.each(b.files,function(a,b){});var c=validateMediaName(b.files[0].name);c.status?(isSave=!1,b.submit()):alert(c.message)},done:function(a,b){isSave=!0;if(!b.result)return alert("未知的错误");if(b.result.status=="fail")return alert(b.result.result);var c=new Media(b.result.result),d=new MediaItemView({model:c});$("#mediaList").children("tbody").prepend(d.render().el),medias.add(c),c=c.toJSON(),medias.get(c.parentId)?medias.get(c.parentId).fetch():null},progressall:function(a,b){var c=parseInt(b.loaded/b.total*100,10);$("#progress").show(),$("#progress .progress-bar").css("width",c+"%"),$("#progresspercent").html(c+"%"),c===100&&($("#progress").hide(),$("#progress .progress-bar").css("width","0%"))}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?undefined:"disabled")}function rmFolder(a){if(a.type==="folder"){var b=medias.filter(function(b){return b.toJSON().parentId===a.id});$.each(b,function(a,b){rmFolder(b.toJSON())})}medias.remove(a)}function updateParent(a,b,c){if(a.parentId!==""){var d=medias.get(a.parentId)?medias.get(a.parentId):a;switch(c){case"create":var e=d.toJSON().size+1;d.set("size",e);break;case"update":break;case"delete":var e=d.toJSON().size-1;d.set("size",e)}d.set("mtime",b)}}function checkMediaNameExist(a,b,c,d,e){var f=medias.filter(function(d){return d.toJSON().name===a&&d.toJSON().type===c&&d.toJSON().parentId===e&&d.toJSON().name!==b});return f.length!==0&&$.each(f,function(f,g){var h="";if(d===0)d+=1,h=a+"("+d+")";else{var i="("+d+")",j=a.lastIndexOf(i),k=a.substring(0,j);d++,h=k+"("+d+")"}var l=checkMediaNameExist(h,b,c,d,e);a=l.tempname,d=l.count}),{tempname:a,count:d}}Media=Backbone.Model.extend({urlRoot:"/media",initialize:function(){},defaults:{name:"全部文件",type:"folder",url:"",size:0,duration:"00:00:10",mtime:(new Date).getTime(),parentId:""}}),Medias=Backbone.Collection.extend({model:Media});var medias=new Medias;MediaListView=Backbone.View.extend({el:"#mediaList",events:{"click #allMedias":"selectAllMedias","click .mediaItemChk":"selectOneMedia","click .sortByName":"sortByName","click .sortByType":"sortByType","click .sortBySize":"sortBySize","click .sortByDuration":"sortByDuration","click .sortByMtime":"sortByMtime"},initialize:function(){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g};var a=this;medias.fetch({url:"/medias",success:function(b,c){var d=medias.sortBy(function(a){return a.get("mtime")});d=d.filter(function(a){return a.toJSON().parentId===""});var e=new MediaNavView({model:initializeModel});$("#mediaNav").append(e.render().el),a.render(d)},error:function(){alert("error")}})},initializeRender:function(){var a=$("#mediaNav").attr("currentId")?$("#mediaNav").attr("currentId"):"",b=medias.sortBy(function(a){return a.get("mtime")}),b=b.filter(function(b){return b.toJSON().parentId===a});this.render(b)},render:function(a){$(this.el).children("tbody").children().remove();var b=$("#mediaList").find(".caret:visible").parents(".sortBy").hasClass("dropup");b?this.renderAsc(a):this.renderDesc(a);var c=$("#searchInput").val().trim();c!==""?$(".mediaParent").show():$(".mediaParent").hide()},renderAsc:function(a){$.each(a,function(a,b){var c=new MediaItemView({model:b});$("#mediaList").children("tbody").append(c.render().el)})},renderDesc:function(a){$.each(a,function(a,b){var c=new MediaItemView({model:b});$("#mediaList").children("tbody").prepend(c.render().el)})},selectAllMedias:function(a){$("#allMedias:checked").length>0?$(".mediaItemChk").prop("checked",!0):$(".mediaItemChk").prop("checked",!1),a&&a.stopPropagation?a.stopPropagation():window.event.cancelBubble=!0},selectOneMedia:function(){$(".mediaItemChk:checked").length==$(".mediaItemChk").length?$("#allMedias").prop("checked",!0):$("#allMedias").prop("checked",!1)},sortByName:function(){this.sortBy("Name")},sortByType:function(){this.sortBy("Type")},sortBySize:function(){this.sortBy("Size")},sortByDuration:function(){this.sortBy("Duration")},sortByMtime:function(){this.sortBy("Mtime")},sortBy:function(a){var b=".sortBy"+a;$(b).find(".caret").show(),$(b).siblings().removeClass("dropup").find(".caret").hide(),$(b).hasClass("dropup")?$(b).removeClass("dropup"):$(b).addClass("dropup");var c=$("#mediaNav").attr("currentId")?$("#mediaNav").attr("currentId"):"",d=medias.sortBy(function(b){return b.get(a.toLowerCase())}),e=$("#searchInput").val().trim();e!==""?d=d.filter(function(a){return a.toJSON().name.indexOf(e)>-1}):d=d.filter(function(a){return a.toJSON().parentId===c}),$("#allMedias").prop("checked",!1),this.render(d)}}),MediaItemView=Backbone.View.extend({tagName:"tr",events:{mouseover:"showOper",mouseout:"hideOper","click .curpointer":"showMediaChild","click .mediaParent":"showMediaParentChild","click .moveMedia":"moveMediaItem","click .deleteMedia":"removeMediaItem","click .renameMedia":"renameMedia"},initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render)},render:function(){var a=this.model.toJSON(),b="",c="重命名";a.mtime=(new moment(parseInt(a.mtime))).lang("zh-cn").from();switch(a.type){case"mstream":b="流媒体",a.size="",c="编辑",a.size="-";break;case"web":b="网页",a.size="",c="编辑",a.size="-";break;case"folder":b="文件夹",a.duration="",a.size="-";break;case"ppt":b="PPT",a.size=filesize(a.size,{base:2}).toUpperCase();break;case"imageSlide":b="图片压缩包",a.size=filesize(a.size,{base:2}).toUpperCase();break;case"picture":b="图片",a.size=filesize(a.size,{base:2}).toUpperCase();break;case"video":b="视频",a.size=filesize(a.size,{base:2}).toUpperCase();break;case"other":b="其他",a.size=filesize(a.size,{base:2}).toUpperCase();break;default:alert("缺省错误")}var d=medias.get(a.parentId)?medias.get(a.parentId).toJSON():initializeModel.toJSON(),e=_.template($("#mediaTemplate").html(),{id:a.id,name:a.name,type:a.type,size:a.size,duration:a.duration,mtime:a.mtime,displayType:b,mediaParentName:d.name,mediaParentId:a.parentId,url:a.url,extName:a.name.split(".").pop(),oprateName:c});return $(this.el).html(e),a.type=="folder"&&($(this.el).find(".mediaName").parent().addClass("curpointer"),$(this.el).find(".downloadMedia").remove()),this},showOper:function(){if($("#uploadInput").length>0||$("#compressAndUpload").length>0)$(this.el).find(".mediaName").parent().removeClass("col-xs-10").addClass("col-xs-6"),$(this.el).find(".mediaOper").show()},hideOper:function(){if($("#uploadInput").length>0||$("#compressAndUpload").length>0)$(this.el).find(".mediaName").parent().removeClass("col-xs-6").addClass("col-xs-10"),$(this.el).find(".mediaOper").hide()},showMediaChild:function(){this.showChild(this.model)},showMediaParentChild:function(){var a=this.model.toJSON().parentId!==""?medias.get(this.model.toJSON().parentId):initializeModel;$("#searchInput").val(""),this.showChild(a)},showChild:function(a){$("#allMedias").prop("checked",!1);var b=a.toJSON().id,c=$("#mediaList").find(".caret:visible").attr("sortColName")?$("#mediaList").find(".caret:visible").attr("sortColName"):"mtime",d=medias.sortBy(function(a){return a.get(c)});d=d.filter(function(a){return a.toJSON().parentId===b}),$("#mediaNav").attr("currentId",b),$("#mediaNav").children().first().nextAll().remove(),a!==initializeModel&&this.showNav(a),mediaListView.render(d);if($("#uploadInput").length>0||$("#compressAndUpload").length>0)fileUpload(),compressAndUpload()},showNav:function(a){var b=this,c=new MediaNavView({model:a});$("#mediaNav").children().first().after(c.render().el);if(a.toJSON().parentId!==""){var d=medias.get(a.toJSON().parentId);b.showNav(d)}},moveMediaItem:function(){var a=[];a.push(this.model.toJSON().id),$("#moveMedia").attr("medias",JSON.stringify(a)),$("#moveMedia").modal("show"),$("#dirList").children().remove();var b=new PathItemView({model:initializeModel});$("#dirList").append(b.render().el)},removeMediaItem:function(){var a=this;if(confirm("确认删除吗？")){var b=this.model,c=medias.get(b.toJSON().parentId)?c=medias.get(b.toJSON().parentId):initializeModel;this.model.destroy().done(function(d){if(d.status==="success"){var e=d.result.mtime;updateParent(c,e,"delete"),rmFolder(b.toJSON()),$(a.el).remove()}})}},showWebStreamModal:function(a){var b=this.model.toJSON();$("#createWedStream").attr("type",a),$("#createWedStream").prop("tmpMediaId",b.id),$("#createWedStreamTxt").val(b.name),$("#createWedStreamUrlTxt").val(b.url);switch(a){case"web":$("#createWedStream").find("h4").html("修改网页"),$("#otherMediaName").html("网页名称："),$("#urlName").html("网页地址："),$("#createWedStreamTxt").prop("placeholder","请输入网页名称"),$("#createWedStreamUrlTxt").prop("placeholder","如：http://www.example.com");break;case"mstream":$("#createWedStream").find("h4").html("修改流媒体"),$("#otherMediaName").html("流媒体名称："),$("#urlName").html("流媒体地址："),$("#createWedStreamTxt").prop("placeholder","请输入流媒体名称"),$("#createWedStreamUrlTxt").prop("placeholder","如：rtsp://110.80.31.70:6000/channe1");break;default:$("#createWedStream").find("h4").html("缺省")}$("#createWedStream").modal("show"),$("#createWedStream").on("shown.bs.modal",function(){$("#createWedStreamTxt").focus()})},renameMedia:function(){var a=this.model.toJSON();switch(a.type){case"mstream":this.showWebStreamModal("mstream");break;case"web":this.showWebStreamModal("web");break;case"folder":var b=a.name;$("#renameMediaTxt").val(b),$("#renameMedia").attr("mediaId",a.id),$("#renameMedia").attr("mediaName",a.name),$("#postifx").hide(),$("#renameMedia").modal("show"),$("#renameMedia").on("shown.bs.modal",function(){$("#renameMediaTxt").focus()});break;default:var c="",b=a.name;if(a.name.split(".").length>1&&a.type!=="folder"){var d=a.name.split(".");d.pop(),b=d.join("."),c="."+a.name.split(".").pop()}$("#renameMediaTxt").val(b),$("#renameMedia").attr("mediaId",a.id),$("#renameMedia").attr("mediaName",a.name),$("#postifx").show(),$("#postifx").html(c),$("#renameMedia").modal("show"),$("#renameMedia").on("shown.bs.modal",function(){$("#renameMediaTxt").focus()})}}}),MediaNavView=Backbone.View.extend({tagName:"li",events:{"click a":"showCurrentFolder"},initialize:function(){},render:function(){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g};var a=this.model.toJSON(),b=a.name.length<10?a.name:a.name.substr(0,10),c=_.template($("#mediaNavTemplate").html(),{id:a.id,name:a.name,displayName:b});return $(this.el).html(c),this},showCurrentFolder:function(){$("#allMedias").prop("checked",!1),$(this.el).nextAll().remove();var a=$(this.el).children("a").attr("currentId");$("#mediaNav").attr("currentId",a);var b=$("#mediaList").find(".caret:visible").attr("sortColName")?$("#mediaList").find(".caret:visible").attr("sortColName"):"mtime",c=medias.sortBy(function(a){return a.get(b)});c=c.filter(function(b){return b.toJSON().parentId===a}),mediaListView.render(c);if($("#uploadInput").length>0||$("#compressAndUpload").length>0)fileUpload(),compressAndUpload()}}),PathItemView=Backbone.View.extend({tagName:"li",events:{"click .selectedFolder":"markChange","click .moveTo":"moveTo"},initialize:function(){},render:function(){var a=this.model.toJSON(),b=a.id,c=medias.filter(function(a){return a.get("parentId")==b&&a.get("type")=="folder"}),d="sp-blank";c.length>0&&(d="sp-plus");var e=a.name.length<20?a.name:a.name.substr(0,20)+"...",f=_.template($("#folderTemplate").html(),{id:a.id,name:e,path:a.path,mark:d});return $(this.el).html(f),this},markChange:function(a){a&&a.stopPropagation?a.stopPropagation():window.event.cancelBubble=!0,a=window.event||a;var b=a.srcElement||a.target;if($(b).hasClass("sp-blank"))return;if($(b).siblings("ul:visible").length===0){$(b).removeClass("sp-plus"),$(b).addClass("sp-minus"),$(b).parent().parent().siblings("li").find("ul:visible").hide(),$.each($(b).parent().parent().siblings("li").find("span"),function(a,b){($(b).hasClass("sp-plus")||$(b).hasClass("sp-minus"))&&$(b).addClass("sp-plus")});if($(b).siblings("ul").length==0){var c=document.createElement("ul");$(c).addClass("nav col-sm-offset-1"),$(b).parent().append(c);var d=$(b).siblings("a").attr("mediaId"),e=medias.filter(function(a){return a.get("parentId")==d&&a.get("type")=="folder"});if(e.length==0)return;$.each(e,function(a,b){var d=b.toJSON(),e=d.id,f=medias.filter(function(a){return a.get("parentId")==e&&a.get("type")=="folder"}),g="sp-blank";f.length>0&&(g="sp-plus");var h=d.name.length<20?d.name:d.name.substr(0,20)+"...",i=_.template($("#folderTemplate").html(),{id:d.id,name:h,path:d.path,mark:g});$(c).append("<li>"+i+"</li>")})}else $(b).siblings("ul").show()}else $(b).addClass("sp-plus"),$(b).removeClass("sp-minus"),$(b).siblings("ul").hide()},moveTo:function(a){a=window.event||a;var b=a.srcElement||a.target;$(".divselected").remove();var c=document.createElement("div");$(c).addClass("divselected"),$(b.parentNode).prepend(c);var d=$(b).attr("mediaId");$("#moveMedia").attr("mediasTo",d)}}),OprateMediaView=Backbone.View.extend({el:"#operateMediaArea",events:{"input #searchInput":"searchMedias","prototypechange #searchInput":"searchMedias","click #searchBtn":"searchMedias","click #uploadFilesBtn":"uploadFilesModal","click #createFolderBtn":"createFolderModal","click #createFolderConfirmBtn":"createFolderConfirm","click #addWebPage":"addWebPage","click #addMediaStream":"addMediaStream","click #createWedStreamConfirmBtn":"createWedStreamConfirm","click #moveBtn":"moveModal","click #moveMediaConfirmBtn":"moveMediaConfirm","click #deleteBtn":"deleteMedias","click #renameMediaConfirmBtn":"renameMediaConfirm"},initialize:function(){},render:function(){},searchMedias:function(){var a=$("#searchInput").val().trim(),b=$("#mediaList").find(".caret:visible").attr("sortColName")?$("#mediaList").find(".caret:visible").attr("sortColName"):"mtime",c=medias.sortBy(function(a){return a.get(b)});$("#mediaNav").children().first().nextAll().remove();if(a!==""){c=c.filter(function(b){return b.toJSON().name.indexOf(a)>-1});var d=document.createElement("li");$(d).html("搜索:'"+a+"'"),$("#mediaNav").append(d),mediaListView.render(c)}else c=c.filter(function(a){return a.toJSON().parentId===""}),mediaListView.render(c);$("#allMedias").prop("checked",!1)},uploadFilesModal:function(){$("#uploadFilesModal").modal("show")},createFolderModal:function(){$("#createFolder").modal("show"),$("#createFolder").on("shown.bs.modal",function(){$("#createFolderTxt").focus()})},createFolderConfirm:function(){var a=$("#mediaNav").attr("currentId")?$("#mediaNav").attr("currentId"):"",b=$("#createFolderTxt").val().trim();if(this.oprateValidateMediaName("#createFolderTxt","文件（夹）名")){b=checkMediaNameExist(b,"","folder",0,a).tempname;var c=new Media({name:b,parentId:a});c.set({duration:""}),c.save().done(function(a){if(a.status==="success"){c.set({id:a.result.id});var b=a.result.mtime;c.set({mtime:b}),updateParent(c.toJSON(),b,"create");var d=new MediaItemView({model:c});$("#mediaList").children("tbody").prepend(d.render().el),$("#createFolderTxt").val(""),medias.add(c),$("#createFolder").modal("hide")}})}},addWebPage:function(){$("#createWedStream").attr("type","web"),this.showWebStreamModal()},addMediaStream:function(){$("#createWedStream").attr("type","mstream"),this.showWebStreamModal()},showWebStreamModal:function(){$("#createWedStream").prop("tmpMediaId",null),$("#createWedStreamTxt").val(""),$("#createWedStreamUrlTxt").val("");var a=$("#createWedStream").attr("type");switch(a){case"web":$("#createWedStream").find("h4").html("添加网页"),$("#otherMediaName").html("网页名称："),$("#urlName").html("网页地址："),$("#createWedStreamTxt").prop("placeholder","请输入网页名称"),$("#createWedStreamUrlTxt").prop("placeholder","如：http://www.example.com");break;case"mstream":$("#createWedStream").find("h4").html("添加流媒体"),$("#otherMediaName").html("流媒体名称："),$("#urlName").html("流媒体地址："),$("#createWedStreamTxt").prop("placeholder","请输入流媒体名称"),$("#createWedStreamUrlTxt").prop("placeholder","如：rtsp://110.80.31.70:6000/channe1");break;default:$("#createWedStream").find("h4").html("缺省")}$("#createWedStream").modal("show"),$("#createWedStream").on("shown.bs.modal",function(){$("#createWedStreamTxt").focus()})},createWedStreamConfirm:function(){var a=$("#createWedStream").prop("tmpMediaId"),b=$("#createWedStream").attr("type"),c=$("#mediaNav").attr("currentId")?$("#mediaNav").attr("currentId"):"",d=$("#createWedStreamTxt").val().trim(),e=$("#createWedStreamUrlTxt").val().trim(),f;if(this.oprateValidateMediaName("#createWedStreamTxt","网页或流媒体名")&&this.oprateValidateMediaUrl("#createWedStreamUrlTxt")){if(!a)d=checkMediaNameExist(d,"",b,0,c).tempname,f=new Media({name:d,parentId:c,type:b,url:e});else{f=medias.get(a);if(f.toJSON().name===d&&f.toJSON().url===e)return $("#createWedStream").modal("hide");d=checkMediaNameExist(d,f.toJSON().name,b,0,c).tempname,f.set({name:d,url:e})}f.save().done(function(b){if(b.status==="success"){if(!a){f.set({id:b.result.id});var c=b.result.mtime;f.set({mtime:c}),updateParent(f.toJSON(),c,"create");var d=new MediaItemView({model:f});$("#mediaList").children("tbody").prepend(d.render().el),$("#createWedStreamTxt").val(""),$("#createWedStreamUrlTxt").val(""),medias.add(f)}else updateParent(f.toJSON(),c,"update");$("#createWedStream").modal("hide")}})}},moveModal:function(){var a=[];$(".mediaItemChk:checked").each(function(b,c){a.push($(c).val())});if(a.length==0)return popBy("#moveBtn",!1,"请先选择您要移动的文件或者文件夹");$("#moveMedia").attr("medias",JSON.stringify(a)),$("#moveMedia").modal("show"),$("#dirList").children().remove();var b=new PathItemView({model:initializeModel});$("#dirList").append(b.render().el)},moveMediaConfirm:function(){var a=$("#mediaNav").attr("currentId")?$("#mediaNav").attr("currentId"):"",b=$("#moveMedia").attr("medias");b=JSON.parse(b);var c=[],d=$("#moveMedia").attr("mediasTo"),e=medias.get(d)?medias.get(d):initializeModel;$.each(b,function(a,b){var f=medias.get(b);if(f.toJSON().parentId!==d&&f.toJSON().id!==d){var g=medias.filter(function(a){return a.toJSON().name===f.toJSON().name&&a.toJSON().type===f.toJSON().type&&a.toJSON().parentId===e.toJSON().id});g.length===0&&c.push(b)}}),c.length>0&&$.ajax({type:"put",url:"/medias/move",data:JSON.stringify({moveMedias:c,mediasTo:d}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(b){if(b.status==="success"){var e=b.result.mtime,f=medias.get(d)?medias.get(d):initializeModel;f.set({mtime:e,size:f.toJSON().size+c.length});var g=medias.get(a)?medias.get(a):initializeModel;g.set({mtime:e,size:g.toJSON().size-c.length}),$.each(c,function(a,b){var c=medias.get(b);c.set({parentId:d})}),mediaListView.initializeRender()}},error:function(a){window.location.reload()}}),$("#moveMedia").modal("hide")},deleteMedias:function(){var a=[];$(".mediaItemChk:checked").each(function(b,c){a.push($(c).val())});if(a.length==0)return popBy("#deleteBtn",!1,"请先选择您要删除的文件或者文件夹");if(confirm("确认删除吗？")){var b=$("#mediaNav").attr("currentId")?$("#mediaNav").attr("currentId"):"",c=medias.get(b)?medias.get(b):initializeModel;$.ajax({type:"DELETE",url:"/medias/",data:JSON.stringify(a),contentType:"application/json; charset=utf-8",dataType:"json",success:function(b){b.status==="success"&&($.each(a,function(a,d){var e=medias.get(d),f=b.result.mtime;updateParent(c,f,"delete"),rmFolder(e.toJSON())}),$("#allMedias").prop("checked",!1),$(".mediaItemChk:checked").parents("tr").remove())},error:function(a){alert(a.responseText)}})}},renameMediaConfirm:function(){var a=$("#mediaNav").attr("currentId")?$("#mediaNav").attr("currentId"):"",b=$("#renameMedia").attr("mediaId"),c=$("#renameMedia").attr("mediaName"),d=medias.get(b),e=$("#postifx:visible").length>0?$("#postifx:visible").html():"",f=$("#renameMediaTxt").val().trim()+e;if(c===f){$("#renameMedia").modal("hide");return}this.oprateValidateMediaName("#renameMediaTxt","文件（夹）名")&&(f=checkMediaNameExist(f,d.toJSON().name,d.toJSON().type,0,a).tempname,d.set({name:f}),d.save().done(function(a){if(a.status==="success"){var b=a.result.mtime;updateParent(d.toJSON(),b,"update"),$("#renameMediaTxt").val(""),$("#renameMedia").modal("hide")}}))},oprateValidateMediaName:function(a,b){var c="",d=!0,e=$(a).val().trim();if(e==="")c="不能为空",d=!1;else{var f=validateMediaName(e);c=f.message,d=f.status}return popBy(a,d,b+c)?!0:!1},oprateValidateMediaUrl:function(a){var b="",c=!0,d=$(a).val().trim();if(d==="")b="网页和流媒体URL不能为空",c=!1;else{var e="^((https|http|ftp|rtsp|mms)?://)?(([0-9a-z_!~*'().&=+$%-]+: )?[0-9a-z_!~*'().&=+$%-]+@)?(([0-9]{1,3}.){3}[0-9]{1,3}|([0-9a-z_!~*'()-]+.)*([0-9a-z][0-9a-z-]{0,61})?[0-9a-z].[a-z]{2,6})(:[0-9]{1,5})?((/?)|(/[0-9a-z_!~*'().;?:@&=+$,%#-]+)+/?)$",f=new RegExp(e,"i");f.test(d)||(c=!1,b="网页和流媒体URL格式错误")}return popBy(a,c,b)?!0:!1}});var initializeModel=new Media({id:""}),mediaListView=new MediaListView,oprateMediaView=new OprateMediaView